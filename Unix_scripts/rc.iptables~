#!/bin/sh
#######################
# Make and disign by  #
# W.Hristew           #
# Eazy-Snatch         #
#http://es.plcnet.org #	
#######################

########## Global Configs #######
ANY=0.0.0.0/0			#
DNS1=194.50.76.2                #
DNS2=213.91.202.154		#
INT=eth1			#
LAN=192.168.1.0/25              #
ipt=/usr/local/sbin/iptables	#
BANIP=`cat /home/.ipblock`	#
TRACE_SRC="32769:65535"		#
TRACE_DEST="33434:33523"	#
ANY="0.0.0.0/0"			#
#################################
############# Network interface ip address ######################################
										
########## WAN IP ###########################################################   # 
IN_IP=`/sbin/ifconfig $INT | grep inet | cut -d : -f 2 | cut -d \  -f 1`    #   #
#############################################################################   # 
										


case "$1" in 
	start)

printf "\e[0;31mStarting Fire Wall  " printf "\e[0;37m" ; echo 


############ Flush all tables ########### 
$ipt -F INPUT 				#
$ipt -F FORWARD 			#
$ipt -F OUTPUT				#
$ipt -t nat -F PREROUTING		#
$ipt -t nat -F POSTROUTING		#
$ipt -F -t mangle			#
$ipt -F					#
$ipt -X					#
#########################################

####### POLICY #########
$ipt -P INPUT DROP     #
$ipt -P FORWARD ACCEPT #
$ipt -P OUTPUT ACCEPT  #
########################

############ BANNED IP/NETWORKS #########
$ipt -N BANNED				#
$ipt -F BANNED				#
if [ -f /home/.ipblock ]; then		#
while read BAN; do			#
$ipt -A INPUT -s $BAN -j BANNED		#
done < /home/.ipblock			#
echo "Ban IP/NET are added to rules"	#
else 					#
echo " File: /home/.ipblock NOT FOUND "	#
fi					#
$ipt -A BANNED -j DROP			#
#########################################
############ Trace ROUTE #################################

############ USE PROXY ##########################################################
#$ipt -A FORWARD -p tcp -s 192.168.0.1/24 -d $LAN --dport 3128 -j DROP		#
#$ipt -A FORWARD -p tcp -s 192.168.0.1/24 -d $LAN --dport 8080 -j DROP		#
#$ipt -t nat -A PREROUTING -i $INT -p tcp --dport 80 -j REDIRECT --to-port 8080	#
#################################################################################
############ Allow limited ICMP #################################################################
#$ipt -A INPUT -i $OUT -p ICMP --icmp-type 0 -j ACCEPT						#
#$ipt -A INPUT -i $OUT -p ICMP --icmp-type 3 -j ACCEPT						#
#$ipt -A INPUT -i $OUT -p ICMP --icmp-type 8 -m limit --limit 6/m -j ACCEPT			#
#$ipt -A INPUT -i $OUT -p ICMP --icmp-type 11 -j ACCEPT						#
#$ipt -A INPUT -i $INT -p ICMP -s 192.168.1.1 --icmp-type 0 -j ACCEPT				#
#$ipt -A INPUT -i $INT -p ICMP -s 192.168.1.1 --icmp-type 11 -j ACCEPT				#
########### Set POLICY in INPUT table ###########################################################
#$ipt -A INPUT -p icmp -j DROP									#
#################################################################################################

#$ipt -A INPUT -p tcp -s 127.0.0.1 -j ACCEPT
#$ipt -A INPUT -p udp -s 127.0.0.1 -j ACCEPT

#$ipt -A INPUT -p tcp -s 127.0.0.1 -j ACCEPT
#$ipt -A INPUT -p udp -s 127.0.0.1 -j ACCEPT
########## ICMP settings ################################################################
########## Drop packets over 8 Bytes ####################################################
#$ipt -A INPUT -p icmp --icmp-type echo-request -m length --length 85:0xffff -j DROP	#
############ Allow limited ICMP #################################################	#		
#$ipt -A INPUT -i $OUT -p ICMP --icmp-type 0 -j ACCEPT                           #	#
#$ipt -A INPUT -i $OUT -p ICMP --icmp-type 3 -j ACCEPT                           #	#
#$ipt -A INPUT -i $OUT -p ICMP --icmp-type 8 -m limit --limit 6/m -j ACCEPT      #	#
#$ipt -A INPUT -i $OUT -p ICMP --icmp-type 11 -j ACCEPT                          #	#
########### Set POLYCI in INPUT table ###########################################	#
#$ipt -A INPUT -p icmp -j DROP                                                   #	#
#################################################################################	#
#########################################################################################
				
######## LIMIT HTTP CONNECTIONS ####################################################
#$ipt -A INPUT -p tcp --syn --dport http -m connlimit --connlimit-above 4 -j REJECT #
####################################################################################

######## PERMIT DNS SERVER #################################
$ipt -A INPUT -p udp -d $DNS1 --dport domain -j ACCEPT     #
$ipt -A INPUT -p udp -d $DNS2 --dport domain -j ACCEPT     #
############################################################

######## PERMIT DC++ ############################
#$ipt -A INPUT -p tcp --dport 8888 -j ACCEPT     #
#$ipt -A INPUT -p udp --dport 8888 -j ACCEPT     #
#################################################
######## Allow Incoming TRACE ROUTE ############################
#$ipt -A INPUT -i $INT -p udp --sport $TRACE_SRC --dport $TRACE_DST -j ACCEPT 

#$ipt -A FORWARD -p udp -s $OUT --sport $TRACE_SRC --dport $TRACE_DST -j ACCEPT 

#$ipt -A FORWARD -p udp -s $OUT --sport $TRACE_DST --dport $TRACE_SRC -j ACCEPT 

######## ALLOW ESTABLISHED connections ###############################
$ipt -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT  #
$ipt -A INPUT -p udp -m state --state ESTABLISHED,RELATED -j ACCEPT  #
######################################################################

######### Allow HTTP servers #################
$ipt -A INPUT -p tcp --dport www -j ACCEPT   #
$ipt -A INPUT -p udp --dport www -j ACCEPT   ####################################
#OGranichavene vrazka samo do 4-ri connecii ot 1-no IP###########################
#$ipt -A INPUT -p tcp --syn --dport http -m iplimit --iplimit-above 4 -j REJECT	#
#################################################################################

######### Allow MAIL ports ###################
#$ipt -A INPUT -p tcp --dport pop3 -j ACCEPT  #
#ipt -A INPUT -p udp --dport pop3 -j ACCEPT  #
#ipt -A INPUT -p tcp --dport smtp -j ACCEPT  #
##############################################

######### Allow IRC ##########################
#$ipt -A INPUT -p tcp --dport ircd -j ACCEPT  #
#$ipt -A INPUT -p tcp --dport 7777 -j ACCEPT  #
##############################################

######### Allow SSH connection on this port ##	
#$ipt -A INPUT -p tcp -s 192.168.1.104 -d 192.168.1.0/25 --dport 22 -j ACCEPT 
$ipt -A INPUT -p tcp --dport ssh -j ACCEPT   #
#$ipt -A INPUT -p udp --dport 65506 -j ACCEPT #
#$ipt -A INPUT -p tcp --dport 65506 -j ACCEPT #
##############################################

######### Allow IPERF connections ###################
#$ipt -A INPUT -p tcp --dport 5001 -j ACCEPT #
#$ipt -A INPUT -p udp --dport 5001 -j ACCEPT #
#####################################################  
######### DROP INVALID PACKAGES #######################
$ipt -A INPUT -p tcp -m state --state INVALID -j DROP #
#######################################################



############ Use HIGH PORT's ################################### 
echo "1024 32768" > /proc/sys/net/ipv4/ip_local_port_range     #
################################################################

#################### Prenasochvane na vrazkata navatre #########
echo "1" > /proc/sys/net/ipv4/ip_forward                       # 
 							       #
iptables -t nat -I POSTROUTING -o eth1 -j MASQUERADE           #
################################################################

####################  TTL Settings ##############################################
#iptables -t mangle -A PREROUTING -i eth1 -j TTL --ttl-inc 1			#
#$ipt -t mangle -A POSTROUTING -o eth1 -j TTL --ttl-inc 1
#iptables -t mangle -A POSTROUTING -s 192.168.0.0/24 -o eth1 -j TTL --ttl-set 64 #
#################################################################################

#################### BROOD WAR PORT #################################################################
#$ipt -A PREROUTING -t nat -p udp -d $IN_IP --dport 6112 -j DNAT --to 192.168.0.2:6112              #
####################################################################################################

################### SOUL SEEK PORT #################################################################
#$ipt -A PREROUTING -t nat -p tcp -d $IN_IP --dport 2240 -j DNAT --to 192.168.0.2:2240		   #
####################################################################################################

################### Local APACHE SERVER ############################################################
#$ipt -A PREROUTING -t nat -p tcp -d $IN_IP --dport 5656 -j DNAT --to $OUT_IP:80 		   #
#$ipt -A PREROUTING -t nat -p tcp -d $IN_IP --dport 8888 -j DNAT --to $OUT_IP:8888 		   #
####################################################################################################

################### WEB CAM ########################################################################
#$ipt -A PREROUTING -t nat -p tcp -d $IN_IP --dport 1003 -j DNAT --to 192.168.0.2:8080		   #
#$ipt -A PREROUTING -t nat -p tcp -d $IN_IP --dport 4000 -j DNAT --to 192.168.0.2:4000		   #
####################################################################################################
#iptables -A OUTPUT -j LOG --log-level info --log-prefix "OUTPUT:"
#iptables -A FORWARD -j LOG --log-level info --log-prefix "FORWARD:"


################## Bad TCP OPTIONS(128) ###########################
$ipt -A INPUT -i $INT -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags ALL FIN -j DROP  	  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags ALL ALL -j DROP	  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags ALL NONE -j DROP	  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags FIN,RST FIN,RST -j DROP  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags ACK,FIN FIN -j DROP	  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags ACK,PSH PSH -j DROP 	  #
$ipt -A INPUT -i $INT -p tcp --tcp-flags ACK,URG URG -j DROP   	  #
$ipt -A INPUT -i $INT -p tcp --tcp-option 64 -j DROP 		  #
$ipt -A INPUT -i $INT -p tcp --tcp-option 128 -j DROP 		  #
###################################################################

################### BAD NETWORK's #######################################################
											#
################### Seting the Private network ####################			#
$ipt -t nat -A PREROUTING -i $INT -s 128.0.0.0/16 -j DROP         #			#
$ipt -t nat -A PREROUTING -i $INT -s 169.254.0.0/16 -j DROP       #			#
$ipt -t nat -A PREROUTING -i $INT -s 172.16.0.0/12 -j DROP        #  			#
$ipt -t nat -A PREROUTING -i $INT -s 191.255.0.0/16 -j DROP       #    			#
$ipt -t nat -A PREROUTING -i $INT -s 192.0.0.0/24 -j DROP         # 			#
$ipt -t nat -A PREROUTING -i $INT -s 192.0.2.0/24 -j DROP         #			#
$ipt -t nat -A PREROUTING -i $INT -s 192.88.99.0/24 -j DROP       #			#
$ipt -t nat -A PREROUTING -i $INT -s 192.168.0.0/16 -j DROP       #			#
$ipt -t nat -A PREROUTING -i $INT -s 198.18.0.0/15 -j DROP        #			#
$ipt -t nat -A PREROUTING -i $INT -s 224.0.0.0/4 -j DROP          #			#
$ipt -t nat -A PREROUTING -i $INT -s 240.0.0.0/4 -j DROP          #			#
$ipt -t nat -A PREROUTING -i $INT -s $IN_IP -j DROP       	  #			#
###################################################################			#
##################  Refuse bogus IP ranges ######################################	#
$ipt -N BOGUS									#	#
$ipt -F BOGUS									#	#
$ipt -A BOGUS -i $INT -s 255.255.255.255/32 -j DROP    # Broadcast		#	#
$ipt -A BOGUS -i $INT -s 127.0.0.0/8 -j DROP           # Loopback		#	#
$ipt -A BOGUS -i $INT -s 169.254.0.0/16 -j DROP        # Link			#	#
$ipt -A BOGUS -i $INT -s 192.0.2.0/24 -j DROP          # Test-net		#	#
$ipt -A BOGUS -i $INT -s 248.0.0.0/5 -j DROP           # Unallocated		#	#
$ipt -A BOGUS -i $INT -s 10.0.0.0/8 -j DROP            # Class A private	#	#
$ipt -A BOGUS -i $INT -s 172.16.0.0/16 -j DROP         # Class B private	#	#
$ipt -A BOGUS -i $INT -s 192.168.0.0/16 -j DROP        # Class C private	#	#
$ipt -A BOGUS -i $INT -s 224.0.0.0/4 -j DROP           # Class D multicast	#	#
$ipt -A BOGUS -i $INT -s 240.0.0.0/5 -j DROP           # Class E reserved	#	#
#################################################################################	#
											#
#########################################################################################

##################  ALLOW INCOMING SAMBA SERVER ###################
# netbios-ns      137/tcp    NETBIOS Name Service		  #
# netbios-ns      137/udp    NETBIOS Name Service		  #
# netbios-dgm     138/tcp    NETBIOS Datagram Service	          #
# netbios-dgm     138/udp    NETBIOS Datagram Service		  #
# netbios-ssn     139/tcp    NETBIOS Session Service		  #
# netbios-ssn     139/udp    NETBIOS Session Service		  #
###################################################################
$ipt -N allow-samba-input					  #
$ipt -F allow-samba-input					  #
$ipt -A allow-samba-input -i $INT -p udp --dport 137 -j ACCEPT	  #
$ipt -A allow-samba-input -i $INT -p tcp --sport 137 -j ACCEPT	  #
$ipt -A allow-samba-input -i $OUT -p udp --sport 137 -j ACCEPT	  #
$ipt -A allow-samba-input -i $OUT -p tcp --dport 138 -j ACCEPT	  #
$ipt -A allow-samba-input -i $OUT -p udp --dport 138 -j ACCEPT 	  #
$ipt -A allow-samba-input -i $OUT -p tcp --sport 138 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p udp --sport 138 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p tcp --dport 139 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p udp --dport 139 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p tcp --sport 139 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p udp --sport 139 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p tcp --dport 445 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p udp --dport 445 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p tcp --sport 445 -j ACCEPT    #
$ipt -A allow-samba-input -i $OUT -p udp --sport 445 -j ACCEPT    #
###################################################################

################### BAD PORTS,TROJAN,BACKDOOR PORTS #############################################
$ipt -N bad-ports										#
$ipt -F bad-ports										#
$ipt -A bad-ports -p tcp -m multiport --dport 1032,3049,1999,4329,1,2,13,98,111,901,902 -j DROP 	#
$ipt -A bad-ports -p udp -m multiport --dport 1032,3049,1999,4329,1,2,13,98,111,901,902 -j DROP 	#
$ipt -A bad-ports -p tcp --dport 12345 -j DROP							#
$ipt -A bad-ports -p udp --dport 12345 -j DROP							#
$ipt -A bad-ports -p tcp --dport 1524 -j DROP							#
$ipt -A bad-ports -p udp --dport 1524 -j DROP							#
$ipt -A bad-ports -p tcp --dport 2049 -j DROP							#
$ipt -A bad-ports -p udp --dport 2049 -j DROP							#
$ipt -A bad-ports -p tcp --dport 27444 -j DROP							#
$ipt -A bad-ports -p udp --dport 27444 -j DROP							#
$ipt -A bad-ports -p tcp --dport 31335 -j DROP							#
$ipt -A bad-ports -p udp --dport 31335 -j DROP							#
$ipt -A bad-ports -p tcp --dport 27665 -j DROP							#
$ipt -A bad-ports -p udp --dport 27665 -j DROP							#
$ipt -A bad-ports -p tcp --dport 31337 -j DROP							#
$ipt -A bad-ports -p udp --dport 31337 -j DROP							#
$ipt -A bad-ports -p tcp --dport 65535 -j DROP							#
$ipt -A bad-ports -p udp --dport 65535 -j DROP							#
#################################################################################################

################### BLOCK OS Fingerprint Detection ##############################################
$ipt -N os-fingerprint										#
$ipt -F os-fingerprint										#
$ipt -A os-fingerprint -p tcp --dport 0 -j DROP							#
$ipt -A os-fingerprint -p udp --dport 0 -j DROP							#
$ipt -A os-fingerprint -p tcp --sport 0 -j DROP							#
$ipt -A os-fingerprint -p udp --sport 0 -j DROP							#
$ipt -A os-fingerprint -p icmp --icmp-type address-mask-request -j DROP				#
$ipt -A os-fingerprint -p icmp --icmp-type address-mask-reply -j DROP				#
#################################################################################################

###################  DROP Bad flags, block portscans, SYN floods ################################
$ipt -N bad-flags										#
$ipt -F bad-flags										#
$ipt -A bad-flags -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP					#
$ipt -A bad-flags -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP				#
$ipt -A bad-flags -p tcp --tcp-flags ALL NONE -j DROP						#
$ipt -A bad-flags -p tcp --tcp-flags SYN,RST SYN,RST -j DROP					#
#################################################################################################

###################  FLOOD PROTECT ##############################################################
$ipt -N protect											#
$ipt -F protect											#
$ipt -A protect -i $INT -s $IN_IP -j DROP							#
$ipt -A protect -s 127.0.0.0/255.0.0.0 -i ! lo -j DROP		                                # 
$ipt -N FLOOD											#
$ipt -F FLOOD											#
$ipt -A FLOOD -p tcp --syn -m limit --limit 2/s -j RETURN				        #
$ipt -A FLOOD -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m limit --limit 2/s -j RETURN 		# 
$ipt -A FLOOD -p tcp -j DROP								        #
												#
################### Drop Fragments ##############################################################
#################################################################################################

########## TOS ##########################################################
#  0x00 = Normal-Service						#
#  0x02 = Minimize-Cost							#
#  0x04 = Maximize-Reliability						#
#  0x08 = Maximize-Throughput						#
#  0x10 = Minimize-Delay						#
# Values were partially determined by RFC 1060/1349			# 
#########################################################################################################
$ipt -t mangle -A PREROUTING -p tcp  -m multiport --dports 443 -j TOS --set-tos 0x04			#
$ipt -t mangle -A PREROUTING -p tcp  -m multiport --dports 20,80 -j TOS --set-tos 0x08			#
$ipt -t mangle -A PREROUTING -p tcp  -m multiport --dports 21,22,25,53 -j TOS --set-tos 0x10		#
$ipt -t mangle -A PREROUTING -p udp  -m multiport --dports 53 -j TOS --set-tos 0x10			#
$ipt -t mangle -A PREROUTING -p icmp --j TOS --set-tos 0x10						#
#########################################################################################################

############### INPUT Connection's #########################
$ipt -A INPUT -j BOGUS                                     #
$ipt -A INPUT -p tcp -m state --state NEW -j FLOOD         #
$ipt -A INPUT -i $INT -j protect			   #
$ipt -A INPUT -j bad-flags				   #
$ipt -A INPUT -j bad-ports				   #
$ipt -A INPUT -j allow-samba-input                         #
$ipt -A INPUT -j os-fingerprint 			   #
############################################################

printf "\e[0;31mFire Wall is UP and Ready " printf "\e[0;37m"; echo -e
/etc/init.d/fail2ban restart
time=`date `
echo -e "Last start was on $time" > /var/log/LASTIPT
exit 1 
 ;;
	stop)

printf "\e[0;31m....Stoping all INTERNET " printf "\e[0;37m" ; echo 


############### Reset the default policies in the filter table.##
$ipt -P INPUT ACCEPT						#
$ipt -P FORWARD ACCEPT						#
$ipt -P OUTPUT ACCEPT						#
#################################################################

############### Reset the default policies in the nat table.#####
$ipt -t nat -P PREROUTING ACCEPT				#
$ipt -t nat -P POSTROUTING ACCEPT				#
$ipt -t nat -P OUTPUT ACCEPT					#
#################################################################

############### Reset the default policies in the mangle table.##
$ipt -t mangle -P PREROUTING ACCEPT				#
$ipt -t mangle -P OUTPUT ACCEPT					#
#################################################################

############### Flush all the rules in the filter and nat tables#
$ipt -F								#	
$ipt -t nat -F							#
$ipt -t mangle -F						#
#################################################################

############### Erase all chains that's not default in filter and nat table.#####
$ipt -X										#
$ipt -t nat -X									#
$ipt -t mangle -X								#
#################################################################################
echo "...done all is ACCEPTED"
exit 1 
   ;;
 	fireoff)
printf "\e[0;31m....Stoping Fire Wall " printf "\e[0;37m" ; echo

############ Flush all tables ###########
$ipt -F INPUT                           #
$ipt -F FORWARD                         #
$ipt -F OUTPUT                          #
$ipt -t nat -F PREROUTING               #
$ipt -t nat -F POSTROUTING              #
$ipt -F -t mangle                       #
$ipt -F                                 #
$ipt -X                                 #
#########################################

####### POLICY #########
$ipt -P INPUT ACCEPT   #
$ipt -P FORWARD ACCEPT #
$ipt -P OUTPUT ACCEPT  #
########################

#################### Prenasochvane na vrazkata navatre #########
echo "1" > /proc/sys/net/ipv4/ip_forward                       #
                                                               #
iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE           #
################################################################
printf "\e[0;31m....Done " printf "\e[0;37m" ; echo
;;
	status)
iptables -nL
;;
	accept)
iptables -nL | grep -i ACCEPT
;;
	drop)
iptables -nL | grep -i DROP 
;;
	chain)
iptables -nL | grep -i chain
;;
	ban)
cat /home/.ipblock
;;
	*)
echo -e $"Use Options: $0 (start||stop||fireoff||status||accept||drop||ban||chain)\n\n"
;;
esac
#End

